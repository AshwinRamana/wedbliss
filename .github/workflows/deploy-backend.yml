name: Deploy Backend

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/wedbliss
            git pull origin main
            cd backend
            npm install --production
            pm2 restart wedbliss-api || pm2 start server.js --name wedbliss-api

      - name: Send Email Notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: WedBliss Deploy Result - ${{ github.workflow }}
          to: ashwinramana7@gmail.com
          from: GitHub Actions
          body: The deployment job '${{ github.job }}' in workflow '${{ github.workflow }}' finished with status '${{ job.status }}'.
